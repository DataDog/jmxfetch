# Java Maven CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-java/ for more details
#
version: 2

defaults: &build-defaults
  docker:
    - image: circleci/openjdk:8-jdk

  working_directory: ~/jmxfetch

  environment:
    MAVEN_OPTS: -Xmx3200m

cache_keys: &cache_keys # Reset the cache approx every release
  keys:
    - jmxfetch-{{ checksum "pom.xml" }}-{{ .Branch }}-{{ .Revision }}
    - jmxfetch-{{ checksum "pom.xml" }}-{{ .Branch }}
    - jmxfetch-{{ checksum "pom.xml" }}

save_cache_steps: &save_cache_steps
  paths:
    - ~/.m2
  key: jmxfetch-{{ checksum "pom.xml" }}-{{ .Branch }}-{{ .Revision }}

default_test_steps: &default_test_steps
  steps:
    - checkout

    # Download and cache dependencies
    - restore_cache:
        <<: *cache_keys

    - run: mvn dependency:go-offline

    - save_cache:
        <<: *save_cache_steps

    - run: |
        mvn verify -B -Dhttps.protocols=TLSv1.2 -DskipTests -Dlog4j.configuration=log4j2.travis.properties
        mvn test -B -Dhttps.protocols=TLSv1.2 -Dcheckstyle.skip=true -Dlog4j.configurationFile=log4j2.travis.properties

jobs:
  test-openjdk7:
    docker:
      - image: jfullaondo/openjdk:7
    environment:
      MVN_EXTRA_OPTS: -Dcheckstyle.version=2.15 -Dcheckstyle.skip
    <<: *default_test_steps
  test-openjdk8:
    docker:
      - image: circleci/openjdk:8u242
    <<: *default_test_steps
  test-openjdk9:
    docker:
      - image: circleci/openjdk:9.0.4-12
    <<: *default_test_steps
  test-openjdk11:
    docker:
      - image: circleci/openjdk:11.0.2
    <<: *default_test_steps
  test-openjdk13:
    docker:
      - image: circleci/openjdk:13.0.2-buster
    <<: *default_test_steps

  build:
    <<: *build-defaults

    steps:
      - checkout

      # Download and cache dependencies
      - restore_cache:
          <<: *cache_keys

      - run: mvn install

      - save_cache:
          <<: *save_cache_steps

      - store_test_results:
          path: ./target/surefire-reports/

      - persist_to_workspace:
          root: .
          paths:
            - target

  deploy:
    <<: *build-defaults

    steps:
      - checkout

      # Download and cache dependencies
      - restore_cache:
          <<: *cache_keys

      - attach_workspace:
          at: .

      - run:
          name: Deploy to bintray
          command: mvn validate jar:jar source:jar javadoc:jar assembly:single deploy:deploy -e --settings ./settings.xml
      - run:
          name: Sync with mavencentral
          command: |
            VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
            curl -f -X POST -H "Content-Type: application/json" \
            --user ${BINTRAY_USER}:${BINTRAY_API_KEY} \
            --data "{\"username\":\"${SONATYPE_USER}\", \"password\":\"${SONATYPE_PWD}\"}" \
            https://api.bintray.com/maven_central_sync/datadog/datadog-maven/jmxfetch/versions/$VERSION

workflows:
  version: 2
  build_test_deploy:
    jobs:
      - test-openjdk7
      - test-openjdk8
      - test-openjdk9
      - test-openjdk11
      - test-openjdk13
      - build:
          requires:
            - test-openjdk7
            - test-openjdk8
            - test-openjdk9
            - test-openjdk11
            - test-openjdk13
          filters:
            tags:
              only: /.*/
      - deploy:
          requires:
            - build
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^\d+\.\d+\.\d+/
